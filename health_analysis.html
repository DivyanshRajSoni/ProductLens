<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Analysis - ProductLens AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3182ce;
            --secondary: #2c5aa0;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --text: #2d3748;
            --light: #f5f7fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #7dd3fc 100%);
            min-height: 100vh;
            color: var(--text);
            position: relative;
            overflow-x: hidden;
        }

        /* Water Wave Animation */
        body::before {
            content: '';
            position: fixed;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: linear-gradient(180deg, 
                transparent 0%, 
                rgba(56, 189, 248, 0.1) 20%,
                rgba(14, 165, 233, 0.15) 40%,
                rgba(2, 132, 199, 0.2) 60%,
                rgba(3, 105, 161, 0.25) 80%,
                rgba(7, 89, 133, 0.3) 100%
            );
            animation: waveFlow 20s linear infinite;
            z-index: 0;
            pointer-events: none;
        }

        /* Ripple Effect */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(ellipse at 20% 30%, rgba(56, 189, 248, 0.3) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 70%, rgba(14, 165, 233, 0.25) 0%, transparent 35%),
                radial-gradient(ellipse at 40% 60%, rgba(2, 132, 199, 0.2) 0%, transparent 30%),
                radial-gradient(ellipse at 70% 20%, rgba(56, 189, 248, 0.28) 0%, transparent 38%);
            animation: ripple 8s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes waveFlow {
            0% {
                transform: translateX(0) translateY(0);
            }
            50% {
                transform: translateX(-25%) translateY(-10px);
            }
            100% {
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes ripple {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 0.6;
            }
            25% {
                transform: scale(1.05) rotate(5deg);
                opacity: 0.8;
            }
            50% {
                transform: scale(0.95) rotate(-3deg);
                opacity: 0.7;
            }
            75% {
                transform: scale(1.02) rotate(2deg);
                opacity: 0.75;
            }
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
            position: relative;
            z-index: 1;
        }

        .page-title {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .page-title h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #1a202c;
            font-weight: 700;
        }

        .page-title p {
            font-size: 1.1rem;
            color: #2d3748;
            font-weight: 500;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .condition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .condition-btn {
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            text-align: center;
        }

        .condition-btn:hover {
            border-color: var(--primary);
            background: #f7fafc;
        }

        .condition-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .analyze-btn {
            background: linear-gradient(135deg, var(--success), #38a169);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .analyze-btn:hover {
            transform: scale(1.05);
        }

        .results {
            display: none;
        }

        .recommendation-card {
            background: #f7fafc;
            border-left: 4px solid var(--success);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .recommendation-card.warning {
            border-left-color: var(--danger);
            background: #fff5f5;
        }

        .recommendation-card h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .product-list {
            list-style: none;
            padding: 0;
        }

        .product-list li {
            padding: 12px;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-safe {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-caution {
            background: #feebc8;
            color: #744210;
        }

        .badge-avoid {
            background: #fed7d7;
            color: #742a2a;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tablet */
        @media (max-width: 968px) {
            .header {
                padding: 15px 20px;
            }

            .logo {
                font-size: 1.3rem;
            }

            .logo img {
                height: 32px !important;
            }

            .container {
                padding: 20px;
                margin: 20px;
            }

            .page-header h1 {
                font-size: 2rem;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
                flex-direction: column;
                gap: 15px;
            }

            .logo {
                font-size: 1.2rem;
            }

            .logo img {
                height: 30px !important;
            }

            .nav-links {
                width: 100%;
                justify-content: center;
                gap: 10px;
            }

            .nav-links a {
                font-size: 0.85rem;
                padding: 6px 10px;
            }

            .container {
                padding: 15px;
                margin: 15px 10px;
            }

            .page-header h1 {
                font-size: 1.75rem;
            }

            .page-header p {
                font-size: 1rem;
            }

            .form-card {
                padding: 20px;
            }

            .form-group label {
                font-size: 0.95rem;
            }

            input[type="text"],
            input[type="number"],
            select {
                padding: 10px;
                font-size: 0.95rem;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .analyze-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }

            .results {
                padding: 20px;
            }

            .recommendation-card {
                padding: 15px;
            }

            .recommendation-card h3 {
                font-size: 1.2rem;
            }
        }

        /* Extra Small Mobile */
        @media (max-width: 480px) {
            .header {
                padding: 10px;
            }

            .logo {
                font-size: 1.1rem;
            }

            .logo img {
                height: 25px !important;
            }

            .nav-links a {
                font-size: 0.8rem;
                padding: 5px 8px;
            }

            .container {
                padding: 10px;
                margin: 10px 5px;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }

            .page-header p {
                font-size: 0.9rem;
            }

            .form-card {
                padding: 15px;
            }

            .form-group label {
                font-size: 0.9rem;
            }

            input[type="text"],
            input[type="number"],
            select {
                padding: 8px;
                font-size: 0.9rem;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .analyze-btn {
                padding: 12px 18px;
                font-size: 0.95rem;
            }

            .results {
                padding: 15px;
            }

            .recommendation-card {
                padding: 12px;
            }

            .recommendation-card h3 {
                font-size: 1.1rem;
            }

            .recommendation-card p,
            .recommendation-card ul li {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="productLens.png" alt="ProductLens" style="height: 40px; vertical-align: middle; margin-right: 8px;">
            ProductLens
        </div>
        <div class="nav-links">
            <a href="product_compare.html"><i class="fas fa-balance-scale"></i> Compare</a>
            <a href="lens_search.html"><i class="fas fa-camera"></i> Scanner</a>
            <a href="index.html"><i class="fas fa-search"></i> Search</a>
        </div>
    </div>

    <div class="container">
        <div class="page-title">
            <h1><i class="fas fa-heartbeat"></i> Personalized Health Analysis</h1>
            <p>Get customized product recommendations based on your health conditions</p>
        </div>

        <div class="card">
            <div class="section-title">
                <i class="fas fa-search"></i> Search Health Condition
            </div>
            
            <div style="position: relative; margin-bottom: 30px;">
                <input type="text" 
                       id="condition-search" 
                       placeholder="Search for conditions like diabetes, hypertension, obesity..." 
                       style="width: 100%; padding: 15px 45px 15px 15px; font-size: 1rem; border: 2px solid #e2e8f0; border-radius: 12px; outline: none; transition: all 0.3s;">
                <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #a0aec0; font-size: 1.2rem;"></i>
                
                <div id="search-suggestions" style="display: none; position: absolute; width: 100%; background: white; border: 2px solid #e2e8f0; border-radius: 12px; margin-top: 5px; max-height: 250px; overflow-y: auto; box-shadow: 0 8px 20px rgba(0,0,0,0.15); z-index: 100;">
                    <!-- Suggestions will appear here -->
                </div>
            </div>

            <div class="section-title">
                <i class="fas fa-hospital"></i> Or Select From Common Conditions
            </div>

            <div class="condition-grid">
                <div class="condition-btn" data-condition="diabetes">
                    <i class="fas fa-tint"></i> Diabetes
                </div>
                <div class="condition-btn" data-condition="hypertension">
                    <i class="fas fa-heart"></i> Hypertension
                </div>
                <div class="condition-btn" data-condition="obesity">
                    <i class="fas fa-weight"></i> Obesity
                </div>
                <div class="condition-btn" data-condition="heart-disease">
                    <i class="fas fa-heartbeat"></i> Heart Disease
                </div>
                <div class="condition-btn" data-condition="kidney">
                    <i class="fas fa-notes-medical"></i> Kidney Issues
                </div>
                <div class="condition-btn" data-condition="fitness">
                    <i class="fas fa-dumbbell"></i> Fitness Goals
                </div>
            </div>

            <button class="analyze-btn" id="analyze-btn">
                <i class="fas fa-microscope"></i> Get Personalized Recommendations
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: rgb(24, 11, 11); font-size: 1.1rem;"><i class="fas fa-robot"></i> AI is generating personalized recommendations...</p>
        </div>

        <div class="results" id="results">
            <!-- Results will be populated here -->
        </div>
    </div>

    <script>
        const conditionBtns = document.querySelectorAll('.condition-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const conditionSearch = document.getElementById('condition-search');
        const searchSuggestions = document.getElementById('search-suggestions');

        let selectedConditions = [];

        // Gemini API key for AI-powered suggestions
        const geminiApiKey = 'AIzaSyC3i5qg9sTBoJUGjsAEGRuT8Es1Ft34J9E';
        
        // All available health conditions with keywords
        const allConditions = [
            { id: 'diabetes', name: 'Diabetes', icon: 'fa-tint', keywords: ['sugar', 'glucose', 'insulin', 'blood sugar', 'diabetic'] },
            { id: 'hypertension', name: 'Hypertension', icon: 'fa-heart', keywords: ['blood pressure', 'high bp', 'hypertensive', 'bp'] },
            { id: 'obesity', name: 'Obesity', icon: 'fa-weight', keywords: ['weight', 'overweight', 'fat', 'weight loss', 'bmi'] },
            { id: 'heart-disease', name: 'Heart Disease', icon: 'fa-heartbeat', keywords: ['cardiac', 'heart', 'cardiovascular', 'cholesterol'] },
            { id: 'kidney', name: 'Kidney Issues', icon: 'fa-notes-medical', keywords: ['kidney', 'renal', 'kidney disease', 'dialysis'] },
            { id: 'fitness', name: 'Fitness Goals', icon: 'fa-dumbbell', keywords: ['fitness', 'workout', 'exercise', 'muscle', 'gym', 'athlete'] },
            { id: 'celiac', name: 'Celiac Disease', icon: 'fa-bread-slice', keywords: ['gluten', 'celiac', 'wheat allergy', 'gluten free'] },
            { id: 'lactose', name: 'Lactose Intolerance', icon: 'fa-ice-cream', keywords: ['lactose', 'dairy', 'milk allergy', 'dairy free'] },
            { id: 'anemia', name: 'Anemia', icon: 'fa-prescription-bottle', keywords: ['anemia', 'iron', 'hemoglobin', 'blood deficiency', 'weakness', 'fatigue'] },
            { id: 'thyroid', name: 'Thyroid Issues', icon: 'fa-capsules', keywords: ['thyroid', 'hypothyroid', 'hyperthyroid', 'iodine'] },
            { id: 'pcos', name: 'PCOS', icon: 'fa-venus', keywords: ['pcos', 'pcod', 'hormonal', 'ovary'] },
            { id: 'gout', name: 'Gout', icon: 'fa-bone', keywords: ['gout', 'uric acid', 'joint pain', 'arthritis'] },
            { id: 'ibs', name: 'IBS', icon: 'fa-stomach', keywords: ['ibs', 'irritable bowel', 'digestive', 'stomach'] },
            { id: 'cholesterol', name: 'High Cholesterol', icon: 'fa-chart-line', keywords: ['cholesterol', 'ldl', 'hdl', 'lipid'] },
            { id: 'osteoporosis', name: 'Osteoporosis', icon: 'fa-bone', keywords: ['osteoporosis', 'bone density', 'calcium', 'bone health'] },
            { id: 'asthma', name: 'Asthma', icon: 'fa-lungs', keywords: ['asthma', 'breathing', 'respiratory', 'inhaler'] },
            { id: 'immunity', name: 'Weak Immunity', icon: 'fa-shield-virus', keywords: ['immunity', 'immune', 'infection', 'fever', 'cold', 'flu', 'sick'] },
            { id: 'migraine', name: 'Migraine', icon: 'fa-head-side-virus', keywords: ['migraine', 'headache', 'head pain'] },
            { id: 'arthritis', name: 'Arthritis', icon: 'fa-bone', keywords: ['arthritis', 'joint', 'inflammation', 'rheumatoid'] },
            { id: 'liver', name: 'Liver Issues', icon: 'fa-hospital', keywords: ['liver', 'hepatic', 'fatty liver', 'cirrhosis'] }
        ];

        let searchTimeout;
        
        // AI-powered search functionality
        conditionSearch.addEventListener('input', async (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length === 0) {
                searchSuggestions.style.display = 'none';
                return;
            }

            // Show loading state
            searchSuggestions.innerHTML = '<div style="padding: 10px; color: #667eea;"><i class="fas fa-spinner fa-spin"></i> AI is finding related conditions...</div>';
            searchSuggestions.style.display = 'block';

            // Clear previous timeout
            clearTimeout(searchTimeout);

            // Debounce AI call (wait 500ms after user stops typing)
            searchTimeout = setTimeout(async () => {
                // First, show local matches
                const localMatches = allConditions.filter(condition => {
                    return condition.name.toLowerCase().includes(query) || 
                           condition.keywords.some(keyword => keyword.includes(query));
                });

                // Get AI suggestions
                let aiSuggestions = [];
                try {
                    aiSuggestions = await getAIDiseasesSuggestions(query);
                    console.log('AI suggestions for', query, ':', aiSuggestions);
                } catch (error) {
                    console.error('AI error:', error);
                }
                
                // ALWAYS include the user's search query as the first option
                const userQuery = query.charAt(0).toUpperCase() + query.slice(1);
                const allSuggestions = [userQuery, ...new Set([...localMatches.map(c => c.name), ...aiSuggestions])];
                
                // Remove duplicates (case-insensitive)
                const uniqueSuggestions = [];
                const seen = new Set();
                for (const suggestion of allSuggestions) {
                    const lower = suggestion.toLowerCase();
                    if (!seen.has(lower)) {
                        seen.add(lower);
                        uniqueSuggestions.push(suggestion);
                    }
                }

                // Display all suggestions
                searchSuggestions.innerHTML = uniqueSuggestions.map((suggestionName, index) => {
                    // Find matching condition from allConditions
                    const condition = allConditions.find(c => c.name.toLowerCase() === suggestionName.toLowerCase()) || 
                                    { id: suggestionName.toLowerCase().replace(/\s+/g, '-'), name: suggestionName, icon: 'fa-heartbeat' };
                    
                    const isUserSearch = index === 0 && suggestionName.toLowerCase() === query.toLowerCase();
                    
                    return `
                        <div class="suggestion-item" data-condition="${condition.id}" data-name="${condition.name}" style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #e2e8f0; transition: all 0.2s; display: flex; align-items: center; gap: 10px; ${isUserSearch ? 'background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-left: 3px solid var(--primary);' : ''}">
                            <i class="fas ${condition.icon}" style="color: var(--primary); font-size: 1.1rem;"></i>
                            <span style="flex: 1;">${condition.name}</span>
                            ${isUserSearch ? '<span style="font-size: 0.75rem; color: var(--primary); font-weight: 600;">‚úì YOUR SEARCH</span>' : ''}
                            ${selectedConditions.includes(condition.id) ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : ''}
                        </div>
                    `;
                }).join('');
                searchSuggestions.style.display = 'block';

                // Add hover effect
                document.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('mouseenter', () => {
                        const isUserSearch = item.querySelector('span:last-child')?.textContent.includes('YOUR SEARCH');
                        item.style.background = isUserSearch ? 'linear-gradient(135deg, #667eea33 0%, #764ba233 100%)' : '#f7fafc';
                    });
                    item.addEventListener('mouseleave', () => {
                        const isUserSearch = item.querySelector('span:last-child')?.textContent.includes('YOUR SEARCH');
                        item.style.background = isUserSearch ? 'linear-gradient(135deg, #667eea22 0%, #764ba222 100%)' : 'white';
                    });
                    item.addEventListener('click', () => {
                        selectConditionFromSearch(item.dataset.condition, item.dataset.name);
                    });
                });
            }, 500);
        });

        // Select condition from search
        function selectConditionFromSearch(conditionId, conditionName = null) {
            const btn = document.querySelector(`.condition-btn[data-condition="${conditionId}"]`);
            
            if (btn) {
                // If button exists, click it
                btn.click();
                btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                // If condition not in visible buttons, add it manually
                if (!selectedConditions.includes(conditionId)) {
                    selectedConditions.push(conditionId);
                    
                    // Find or create condition object
                    let condition = allConditions.find(c => c.id === conditionId);
                    if (!condition && conditionName) {
                        // Create dynamic condition from user input
                        condition = {
                            id: conditionId,
                            name: conditionName,
                            icon: 'fa-heartbeat'
                        };
                    }
                    
                    // Create a selected indicator badge
                    const indicator = document.createElement('div');
                    indicator.id = `selected-${conditionId}`;
                    indicator.style.cssText = 'display: inline-block; padding: 10px 16px; margin: 5px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 25px; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); animation: slideIn 0.3s ease;';
                    indicator.innerHTML = `<i class="fas ${condition.icon}"></i> ${condition.name} <i class="fas fa-times-circle" style="margin-left: 8px; cursor: pointer; opacity: 0.8;"></i>`;
                    
                    indicator.querySelector('.fa-times-circle').addEventListener('click', () => {
                        selectedConditions = selectedConditions.filter(c => c !== conditionId);
                        indicator.remove();
                    });
                    
                    // Add after condition grid
                    const grid = document.querySelector('.condition-grid');
                    if (!document.getElementById('selected-conditions-container')) {
                        const container = document.createElement('div');
                        container.id = 'selected-conditions-container';
                        container.style.cssText = 'margin: 20px 0; padding: 15px; background: #f7fafc; border-radius: 12px; min-height: 50px;';
                        container.innerHTML = '<p style="color: #667eea; font-weight: 600; margin-bottom: 10px;"><i class="fas fa-check-circle"></i> Selected Conditions:</p>';
                        grid.insertAdjacentElement('afterend', container);
                    }
                    document.getElementById('selected-conditions-container').appendChild(indicator);
                }
            }
            
            conditionSearch.value = '';
            searchSuggestions.style.display = 'none';
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!conditionSearch.contains(e.target) && !searchSuggestions.contains(e.target)) {
                searchSuggestions.style.display = 'none';
            }
        });

        // AI-powered disease suggestion function
        async function getAIDiseasesSuggestions(symptomQuery) {
            try {
                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`;
                
                const response = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Based on the symptom or condition keyword "${symptomQuery}", list 5-8 related health conditions or diseases that people commonly search for. Return ONLY the condition names as a comma-separated list, no explanations. For example, if input is "sugar", output should be: "Diabetes, Prediabetes, Hypoglycemia, Metabolic Syndrome". Be concise and medically accurate.`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 100
                        }
                    })
                });

                if (!response.ok) {
                    console.error('Gemini API error:', response.status);
                    return [];
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                
                if (!text) return [];

                // Parse the comma-separated list
                const suggestions = text.split(',').map(s => s.trim()).filter(s => s.length > 0);
                return suggestions.slice(0, 8); // Limit to 8 suggestions
                
            } catch (error) {
                console.error('AI suggestion error:', error);
                return [];
            }
        }

        // Focus effect for search
        conditionSearch.addEventListener('focus', () => {
            conditionSearch.style.borderColor = 'var(--primary)';
            conditionSearch.style.boxShadow = '0 0 0 3px rgba(49, 130, 206, 0.1)';
        });

        conditionSearch.addEventListener('blur', () => {
            conditionSearch.style.borderColor = '#e2e8f0';
            conditionSearch.style.boxShadow = 'none';
        });

        // Handle condition selection
        conditionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const condition = btn.dataset.condition;

                if (btn.classList.contains('selected')) {
                    btn.classList.remove('selected');
                    selectedConditions = selectedConditions.filter(c => c !== condition);
                } else {
                    btn.classList.add('selected');
                    selectedConditions.push(condition);
                }
            });
        });

        // Analyze and get recommendations
        analyzeBtn.addEventListener('click', async () => {
            if (selectedConditions.length === 0) {
                alert('Please select at least one health condition!');
                return;
            }

            loading.style.display = 'block';
            results.style.display = 'none';

            // Call AI for personalized recommendations
            await generateRecommendations();

            loading.style.display = 'none';
            results.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth' });
        });

        // Generate AI-powered personalized recommendations using Gemini 2.0 Flash
        async function generateRecommendations() {
            try {
                // Get condition names
                const conditionNames = selectedConditions.map(id => {
                    const condition = allConditions.find(c => c.id === id);
                    return condition ? condition.name : id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }).join(', ');

                console.log('ü§ñ Requesting AI recommendations for:', conditionNames);
                console.log('üîë Using API key:', geminiApiKey.substring(0, 20) + '...');

                // Try multiple models in case of overload
                const models = ['gemini-2.5-flash', 'gemini-2.0-flash', 'gemini-flash-latest'];
                let lastError = null;

                for (const model of models) {
                    try {
                        console.log(`üîÑ Trying model: ${model}`);
                        const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;
                        console.log('üåê API URL:', geminiUrl.replace(geminiApiKey, 'KEY_HIDDEN'));
                
                const response = await fetch(geminiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a nutrition and health expert. A person has the following health conditions: ${conditionNames}.

IMPORTANT: Return ONLY valid JSON with no additional text, markdown, or code blocks.

{
  "summary": "Brief overview of dietary needs (2-3 sentences)",
  "recommendations": [
    {
      "category": "Category name (e.g., Beverages, Snacks, Grains, Dairy)",
      "icon": "fas fa-coffee",
      "advice": "Specific advice for this category",
      "safeProducts": ["Product 1", "Product 2", "Product 3"],
      "avoidProducts": ["Product 1", "Product 2", "Product 3"],
      "keyNutrients": ["Nutrient 1 to watch", "Nutrient 2 to watch"]
    }
  ],
  "generalTips": ["Tip 1", "Tip 2", "Tip 3", "Tip 4", "Tip 5"]
}

Provide 4-6 food categories with specific product examples commonly available in India. Use Font Awesome icons like: fas fa-coffee, fas fa-apple-alt, fas fa-bread-slice, fas fa-cheese, fas fa-carrot, fas fa-cookie. Be medically accurate and practical.

Return ONLY the JSON object, nothing else.`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 2500
                        }
                    })
                });

                console.log('üì° API Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå API Error with ${model}:`, errorText);
                    
                    // If model is overloaded, try next model
                    if (response.status === 503 || errorText.includes('overloaded') || errorText.includes('503')) {
                        console.log(`‚è≠Ô∏è Model ${model} is overloaded, trying next...`);
                        lastError = new Error(`Model overloaded: ${model}`);
                        continue;
                    }
                    
                    throw new Error('Gemini API error: ' + response.status);
                }

                const data = await response.json();
                console.log('üì¶ Raw API response:', JSON.stringify(data, null, 2));
                
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                
                if (!text) {
                    console.error('‚ùå No text in response');
                    console.error('Response structure:', data);
                    lastError = new Error('No response from AI');
                    continue;
                }

                console.log('üìù AI Text response:', text);

                // Parse JSON from response (remove markdown code blocks if present)
                let jsonText = text;
                if (text.includes('```json')) {
                    jsonText = text.match(/```json\n?([\s\S]*?)\n?```/)?.[1] || text;
                } else if (text.includes('```')) {
                    jsonText = text.match(/```\n?([\s\S]*?)\n?```/)?.[1] || text;
                }

                // Try to parse JSON
                let aiRecommendations;
                try {
                    aiRecommendations = JSON.parse(jsonText.trim());
                    console.log('‚úÖ Parsed recommendations:', aiRecommendations);
                } catch (parseError) {
                    console.error('‚ùå JSON Parse Error:', parseError);
                    console.error('Raw text:', jsonText);
                    
                    // Try to find JSON object in the text
                    const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        aiRecommendations = JSON.parse(jsonMatch[0]);
                        console.log('‚úÖ Parsed recommendations (second attempt):', aiRecommendations);
                    } else {
                        lastError = new Error('Could not extract valid JSON from response');
                        continue;
                    }
                }

                // Validate the structure
                if (!aiRecommendations.summary || !aiRecommendations.recommendations || !aiRecommendations.generalTips) {
                    console.error('‚ùå Invalid response structure:', aiRecommendations);
                    lastError = new Error('AI response missing required fields');
                    continue;
                }
                
                // Success! Display AI recommendations
                console.log(`‚úÖ Successfully got recommendations from ${model}`);
                displayAIRecommendations(aiRecommendations, conditionNames);
                return; // Exit function on success

                    } catch (modelError) {
                        console.error(`‚ùå Error with model ${model}:`, modelError);
                        lastError = modelError;
                        continue;
                    }
                }

                // If all models failed, show fallback
                console.error('üí• All models failed:', lastError);
                displayFallbackRecommendations();

            } catch (error) {
                console.error('üí• AI recommendation error:', error);
                console.error('Stack:', error.stack);
                // Fallback to basic recommendations
                displayFallbackRecommendations();
            }
        }

        // Display AI-powered recommendations
        function displayAIRecommendations(data, conditionNames) {
            results.innerHTML = `
                <div class="card">
                    <div class="section-title" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <i class="fas fa-robot" style="font-size: 2rem;"></i>
                            <div>
                                <h3 style="margin: 0; font-size: 1.3rem;">AI-Powered Personalized Analysis</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Based on: ${conditionNames}</p>
                            </div>
                        </div>
                        <p style="margin: 10px 0 0 0; font-size: 1rem; opacity: 0.95;">${data.summary}</p>
                    </div>

                    ${data.recommendations.map(rec => `
                        <div class="recommendation-card" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 20%); border-left: 4px solid var(--primary); margin-bottom: 20px;">
                            <h4 style="color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <i class="${rec.icon}" style="font-size: 1.3rem;"></i>
                                ${rec.category}
                            </h4>
                            <p style="color: #2d3748; margin-bottom: 15px; font-weight: 500;">${rec.advice}</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
                                    <h5 style="color: #155724; margin: 0 0 10px 0;"><i class="fas fa-check-circle"></i> Safe Options</h5>
                                    <ul style="margin: 0; padding-left: 20px; color: #155724;">
                                        ${rec.safeProducts.map(p => `<li style="margin: 5px 0;">${p}</li>`).join('')}
                                    </ul>
                                </div>
                                <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                                    <h5 style="color: #721c24; margin: 0 0 10px 0;"><i class="fas fa-times-circle"></i> Avoid</h5>
                                    <ul style="margin: 0; padding-left: 20px; color: #721c24;">
                                        ${rec.avoidProducts.map(p => `<li style="margin: 5px 0;">${p}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>

                            <div style="margin-top: 15px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                                <strong style="color: var(--primary);"><i class="fas fa-exclamation-triangle"></i> Watch Out For:</strong>
                                <span style="color: #4a5568; margin-left: 8px;">${rec.keyNutrients.join(', ')}</span>
                            </div>
                        </div>
                    `).join('')}

                    <div class="recommendation-card" style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border-left: 4px solid #fdcb6e;">
                        <h4 style="color: #2d3748;"><i class="fas fa-lightbulb"></i> AI General Health Tips</h4>
                        <ul style="padding-left: 20px; margin-top: 10px; color: #2d3748;">
                            ${data.generalTips.map(tip => `<li style="margin: 8px 0;">${tip}</li>`).join('')}
                        </ul>
                    </div>

                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #e6f3ff; border-radius: 8px; border: 1px dashed #667eea;">
                        <p style="color: #667eea; margin: 0; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> <strong>Disclaimer:</strong> This is AI-generated advice. Always consult with healthcare professionals for personalized medical guidance.
                        </p>
                    </div>
                </div>
            `;
        }

        // Fallback recommendations if AI fails
        function displayFallbackRecommendations() {
            const conditionNames = selectedConditions.map(id => {
                const condition = allConditions.find(c => c.id === id);
                return condition ? condition.name : id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }).join(', ');

            const recommendations = getRecommendationsForConditions(selectedConditions);

            // If no specific recommendations, show generic advice
            if (recommendations.length === 0) {
                results.innerHTML = `
                    <div class="card">
                        <div class="section-title" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin: 0;"><i class="fas fa-exclamation-triangle"></i> AI Recommendations Unavailable</h3>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">Conditions selected: ${conditionNames}</p>
                        </div>

                        <div class="recommendation-card" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <h4 style="color: #856404;"><i class="fas fa-info-circle"></i> General Dietary Guidance</h4>
                            <p style="color: #856404;">For <strong>${conditionNames}</strong>, we recommend consulting with a healthcare professional for personalized advice. In the meantime, focus on:</p>
                            <ul style="padding-left: 20px; margin-top: 10px; color: #856404;">
                                <li>Eating a balanced diet with fresh fruits and vegetables</li>
                                <li>Staying hydrated with plenty of water</li>
                                <li>Avoiding processed and packaged foods</li>
                                <li>Reading nutrition labels carefully</li>
                                <li>Getting adequate rest and exercise</li>
                            </ul>
                        </div>

                        <div class="recommendation-card" style="background: #d1ecf1; border-left: 4px solid #17a2b8;">
                            <h4 style="color: #0c5460;"><i class="fas fa-lightbulb"></i> Product Selection Tips</h4>
                            <ul style="padding-left: 20px; margin-top: 10px; color: #0c5460;">
                                <li>Choose products with less than 5g sugar per serving</li>
                                <li>Avoid products with high sodium (>400mg per serving)</li>
                                <li>Look for high fiber content (>3g per serving)</li>
                                <li>Check for artificial additives and preservatives</li>
                                <li>Prefer natural and whole food options</li>
                            </ul>
                        </div>

                        <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8d7da; border-radius: 8px;">
                            <p style="color: #721c24; margin: 0;">
                                <i class="fas fa-robot"></i> <strong>Note:</strong> AI recommendations are temporarily unavailable. Please try again or consult with a healthcare professional.
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            results.innerHTML = `
                <div class="card">
                    <div class="section-title">
                        <i class="fas fa-check-circle"></i> Your Personalized Recommendations
                    </div>

                    ${recommendations.map(rec => `
                        <div class="recommendation-card ${rec.type}">
                            <h4>${rec.title}</h4>
                            <p>${rec.description}</p>
                            ${rec.products ? `
                                <ul class="product-list">
                                    ${rec.products.map(p => `
                                        <li>
                                            <span>${p.name}</span>
                                            <span class="badge badge-${p.status}">${p.label}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `).join('')}

                    <div class="recommendation-card">
                        <h4><i class="fas fa-lightbulb"></i> General Health Tips</h4>
                        <ul style="padding-left: 20px; margin-top: 10px;">
                            <li>Always check nutrition labels before buying</li>
                            <li>Choose products with less than 5g sugar per serving</li>
                            <li>Avoid products with high sodium (>400mg per serving)</li>
                            <li>Look for high fiber content (>3g per serving)</li>
                            <li>Consult your doctor for specific dietary needs</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Get recommendations based on conditions
        function getRecommendationsForConditions(conditions) {
            const allRecommendations = [];

            if (conditions.includes('diabetes')) {
                allRecommendations.push({
                    title: '<i class="fas fa-tint"></i> Diabetes Management',
                    description: 'Focus on low-sugar, high-fiber foods. Avoid sugary drinks and processed snacks.',
                    type: '',
                    products: [
                        { name: 'Diet Coke (Zero Sugar)', status: 'safe', label: 'Safe' },
                        { name: 'Plain Water', status: 'safe', label: 'Best Choice' },
                        { name: 'Unsweetened Green Tea', status: 'safe', label: 'Safe' },
                        { name: 'Coca Cola', status: 'avoid', label: 'Avoid' },
                        { name: 'Maaza (High Sugar)', status: 'avoid', label: 'Avoid' }
                    ]
                });
            }

            if (conditions.includes('hypertension')) {
                allRecommendations.push({
                    title: '<i class="fas fa-heart"></i> Hypertension Control',
                    description: 'Reduce sodium intake. Avoid salty snacks and processed foods.',
                    type: '',
                    products: [
                        { name: 'Fresh Fruits', status: 'safe', label: 'Best Choice' },
                        { name: 'Unsalted Nuts', status: 'safe', label: 'Safe' },
                        { name: 'Low-Sodium Soup', status: 'caution', label: 'Moderate' },
                        { name: 'Kurkure (High Sodium)', status: 'avoid', label: 'Avoid' },
                        { name: 'Salted Chips', status: 'avoid', label: 'Avoid' }
                    ]
                });
            }

            if (conditions.includes('obesity')) {
                allRecommendations.push({
                    title: '<i class="fas fa-weight"></i> Weight Management',
                    description: 'Choose low-calorie, nutrient-dense foods. Avoid high-fat and high-sugar products.',
                    type: '',
                    products: [
                        { name: 'Vegetables & Salads', status: 'safe', label: 'Best Choice' },
                        { name: 'Lean Protein', status: 'safe', label: 'Safe' },
                        { name: 'Whole Grain Products', status: 'caution', label: 'Moderate' },
                        { name: 'Chocolate (High Calories)', status: 'avoid', label: 'Avoid' },
                        { name: 'Fried Snacks', status: 'avoid', label: 'Avoid' }
                    ]
                });
            }

            if (conditions.includes('heart-disease')) {
                allRecommendations.push({
                    title: '<i class="fas fa-heartbeat"></i> Heart Health',
                    description: 'Low sodium, low saturated fat, high omega-3. Avoid trans fats and cholesterol.',
                    type: '',
                    products: [
                        { name: 'Oats & Whole Grains', status: 'safe', label: 'Best Choice' },
                        { name: 'Nuts & Seeds', status: 'safe', label: 'Safe' },
                        { name: 'Fish (Omega-3)', status: 'safe', label: 'Excellent' },
                        { name: 'Butter & Ghee', status: 'avoid', label: 'Avoid' },
                        { name: 'Fast Food', status: 'avoid', label: 'Avoid' }
                    ]
                });
            }

            if (conditions.includes('kidney')) {
                allRecommendations.push({
                    title: '<i class="fas fa-notes-medical"></i> Kidney Health',
                    description: 'Low sodium, low potassium, moderate protein. Limit phosphorus intake.',
                    type: '',
                    products: [
                        { name: 'Rice & White Bread', status: 'safe', label: 'Safe' },
                        { name: 'Apples & Grapes', status: 'safe', label: 'Safe' },
                        { name: 'Cucumber', status: 'safe', label: 'Best Choice' },
                        { name: 'Bananas (High K)', status: 'caution', label: 'Limit' },
                        { name: 'Dairy Products', status: 'caution', label: 'Limit' }
                    ]
                });
            }

            if (conditions.includes('fitness')) {
                allRecommendations.push({
                    title: '<i class="fas fa-dumbbell"></i> Fitness & Muscle Building',
                    description: 'High protein, complex carbs, healthy fats. Stay hydrated.',
                    type: '',
                    products: [
                        { name: 'Chicken Breast', status: 'safe', label: 'Excellent' },
                        { name: 'Eggs', status: 'safe', label: 'Best Choice' },
                        { name: 'Greek Yogurt', status: 'safe', label: 'Great' },
                        { name: 'Sweet Potato', status: 'safe', label: 'Good Carbs' },
                        { name: 'Protein Shakes', status: 'caution', label: 'Moderate' }
                    ]
                });
            }

            // Warning if multiple serious conditions
            if (conditions.includes('diabetes') && conditions.includes('hypertension')) {
                allRecommendations.unshift({
                    title: '<i class="fas fa-exclamation-triangle"></i> Multiple Conditions Detected',
                    description: 'You have selected multiple serious health conditions. It is highly recommended to consult with a healthcare professional or registered dietitian for a comprehensive diet plan tailored to your specific needs.',
                    type: 'warning'
                });
            }

            return allRecommendations;
        }
    </script>
</body>
</html>
